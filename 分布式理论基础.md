
# <center> 分布式事务处理理论基础

## 概述

CAP定理：分布式系统无法同时满足一致性（Consistency）、可用性（Availability）和分区容错性（Partition Tolerance）三个指标，最多只能满足其中两个。

BASE理论：是对CAP定理的一种解决思路，包含基本可用（Basically Available）、软状态（Soft State）和最终一致性（Eventually Consistent）三个思想。


## CAP
### 一致性
一致性是指多副本（Replications）问题中的数据一致性。可以分为强一致性、顺序一致性与弱一致性。

- 强一致性
	- 系统中的某个数据被成功更新后，后续任何对该数据的读取操作都将得到更新后的值；
	- 也称为：**原子一致性（Atomic Consistency）**， **线性一致性（Linearizable Consistency）**
	- 两个要求：
	
			任何一次读都能读到某个数据的最近一次写的数据。
			系统中的所有进程，看到的操作顺序，都和全局时钟下的顺序一致。

			例如，对于关系型数据库，要求更新过的数据能被后续的访问都能看到，这是强一致性。
	- 总结：
			
			一个集群需要对外部提供强一致性，所以只要集群内部某一台服务器的数据发生了改变，
			那么就需要等待集群内其他服务器的数据同步完成后，才能正常的对外提供服务。
			
			保证了强一致性，务必会损耗可用性。
- 顺序一致性
	- 所有节点或处理器观察到的操作顺序应该是一致的，且这种顺序与程序代码中指定的顺序相匹配。
	- 定义
		
			顺序一致性要求分布式系统中的所有节点或处理器在执行操作时，
			必须遵循程序中指定的顺序，且这种顺序在所有节点或处理器之间是一致的。
			换句话说，如果一个节点观察到某个操作发生在另一个操作之前，那么所有节点都应该观察到这样的顺序。
	- 特性
	
			全局一致的操作顺序：
			在分布式系统中，顺序一致性确保所有节点看到的操作顺序是全局一致的，这有助于避免数据不一致和冲突。
			
			会话内的写有序且会按序被读到：
			在顺序一致性下，一个会话内的写操作是有序的，并且这些写操作的结果会按照相同的顺序被其他会话读到。
			
			时间的顺序性：
			顺序一致性强调时间的顺序性，即操作的发生顺序在所有节点之间是一致的，尽管实际执行时可能存在时间差。	


	- 实现方式：在分布式系统中实现顺序一致性通常需要采用适当的同步机制和协调算法。
	
			例如，可以使用分布式锁、时间戳排序、事务日志等技术来确保操作的顺序性和一致性。
			此外，一些分布式系统还提供了内置的顺序一致性保证，如某些分布式数据库和消息队列系统。
	- 应用场景：
			顺序一致性在分布式系统中有着广泛的应用场景，特别是在需要保证操作顺序和数据一致性的场景中。例如：

			分布式队列：在分布式队列中，顺序一致性可以确保消息的顺序传递，从而避免消息乱序导致的问题。
			分布式事务：在分布式事务处理中，顺序一致性可以确保事务的串行化执行，从而避免数据不一致和冲突。
			分布式缓存：在分布式缓存系统中，顺序一致性可以确保缓存数据的更新和读取顺序一致，从而保持缓存数据的一致性。
- 弱一致性

	在分布式系统中，弱一致性（Weak Consistency）是一种数据一致性模型，它允许在数据更新后，不保证任何时刻任何节点的读取操作都能得到最新的值。这种一致性模型相对于强一致性（Strong Consistency）而言，在数据的实时性和准确性上有所妥协，但能够提供更好的性能和可用性。

	- 弱一致性的特点
	
			非即时性：数据更新后，读取操作可能无法立即获取到最新的值，存在一定的时间延迟。
			不一致性：在数据更新后的一段时间内，不同节点间可能存在数据不一致的情况。
			提高性能：由于不需要等待所有节点的确认，写入操作可以更快地返回成功，从而提高了系统的整体性能。
			
	- 弱一致性的实现方式
	
			弱一致性通常采用异步复制（Asynchronous Replication）的方式来实现。
			在异步复制中，写入操作不等待其他节点的响应就返回成功，这样可以显著降低写入操作的延迟。
			然而，这也意味着在写入操作成功返回后，其他节点可能还没有同步到最新的数据。

	- 弱一致性的应用场景
	
			弱一致性适用于对数据实时性要求不高，或者可以容忍数据不一致的业务场景。例如：
		
			社交网络：
			在社交网络中，用户头像的更新、状态的发布等操作，通常不需要立即在所有节点上同步最新的数据。
			因此，可以使用弱一致性来提高系统的响应速度和可用性。
		
			搜索引擎：
			搜索引擎在索引数据时，由于数据量巨大且更新频繁，使用弱一致性可以减少索引的延迟和开销。
		
			缓存服务：
			在缓存服务中，为了提高缓存的命中率和性能，通常会使用弱一致性来同步缓存数据。
			即使缓存中的数据不是最新的，也不会对业务造成太大的影响。
	


- 最终一致性
	- 弱一致性的变种
			
			弱一致性模型有很多不同的形式，其中最终一致性（Eventual Consistency）是一种较为常见的变种。
			最终一致性要求在没有新的更新操作发生后，所有节点最终会达到一致状态。
			这种一致性模型在实际应用中非常广泛，因为它能够在保证系统性能的同时，满足大多数业务场景对数据一致性的需求。



### 可用性



- 定义

		可用性指的是系统能够在非故障节点上，在合理的时间内返回合理的响应（不是错误和超时的响应）。
		这意味着系统应该能够持续不断地处理用户的请求，即使部分节点出现故障或不可用，系统仍然需要保证能够正常响应用户的请求。

- 特点

		非故障节点的响应能力：可用性要求系统在没有发生故障的情况下，必须能够正常处理并响应用户的请求。

		合理的响应时间：系统需要在合理的时间内返回响应，以避免用户因等待时间过长而产生不满或放弃操作。

		错误和超时避免：系统应避免返回错误或超时的响应，这有助于提升用户体验和系统的整体可靠性。

- 在CAP理论中的位置

	CAP理论指出，在分布式系统中，一致性（Consistency）、可用性（Availability）和分区容错性（Partition Tolerance）这三个属性无法同时完全达到。由于现实世界中的分布式系统通常都需要保证分区容错性（即能够容忍网络分区的情况），因此系统必须在一致性和可用性之间做出权衡。
	
			如果选择可用性优先于一致性，那么在发生网络分区时，系统仍然会响应请求，但可能无法保证数据的即时一致性。
			这种策略可以提高用户体验和系统的性能，但在某些对一致性要求较高的场景下可能不适用。
			
			如果选择一致性优先于可用性，那么在发生网络分区时，系统可能会拒绝或延迟响应请求，以保证数据的一致性。
			这种策略适用于对一致性要求较高的场景，但可能会牺牲系统的可用性和性能。

- 实际应用

	在实际应用中，开发者需要根据具体场景的需求来选择合适的策略来平衡一致性和可用性。例如，
			
		在金融交易系统中，由于对数据一致性的要求较高，因此可能会选择牺牲一定的可用性来保证数据的一致性；

		而在日志记录、数据投递等场景中，由于对数据一致性的要求较低，因此可能会选择牺牲一致性来保证系统的可用性和性能。




### 分区容错性



- 定义


	分区容错性指的是在分布式系统中，当系统内部的某个或某些节点之间出现网络通信中断或延迟时，系统仍然能够继续对外提供服务的能力。这种能力确保了系统在面对网络分区故障时的鲁棒性和可靠性。

- 特点

	- 网络故障的容忍性：分区容错性要求系统能够容忍网络通信的中断或延迟，即使部分节点之间无法通信，系统仍然能够保持整体的服务能力。

	- 服务的连续性：在出现网络分区时，系统需要确保服务的连续性，不会因为部分节点的故障或网络问题而导致整个系统不可用。
	
	- 数据的可访问性：系统需要保证即使在网络分区的情况下，用户仍然能够访问到部分或全部的数据，以满足业务需求。

- 在CAP理论中的位置


	CAP理论指出，在分布式系统中，一致性（Consistency）、可用性（Availability）和分区容错性（Partition Tolerance）这三个属性无法同时完全达到。由于现实世界中的分布式系统通常都需要部署在多个地理位置上，通过网络进行通信，因此网络分区是一个无法避免的问题。因此，在分布式系统设计中，分区容错性通常被视为一个必须保证的属性。

- 实际应用


	在实际应用中，开发者需要根据具体场景的需求来选择合适的策略来平衡CAP三个属性之间的关系。**由于分区容错性是必须保证的，因此系统设计者通常需要在一致性和可用性之间做出权衡。**

	- 如果业务场景对一致性要求较高，可以选择牺牲一定的可用性来保证数据的一致性。例如，
		
			在数据库系统中，可以使用强一致性模型来确保数据的实时一致性，但这可能会增加系统的复杂性和延迟。
	
	- 如果业务场景对可用性要求较高，可以选择牺牲一定的数据一致性来保证系统的可用性。例如，
	
			在缓存系统中，可以使用最终一致性模型来确保数据的最终一致性，同时提高系统的响应速度和吞吐量。



## BASE 理论
### 基本可用
	不期望所有的服务和功能可用，在出现故障以后，通过降级、响应时间增加、保证关键链路可用等方式。
	实现方式：负载均衡，容错机制、降级策略
	

### 软状态
指的是分布式系统中的数据或状态允许存在中间状态，并且这种中间状态的存在不会影响到系统的整体可用性。
	软状态主要是由于数据同步存在延时而引起的，它体现了分布式系统对实时一致性要求的弱化和对更高可用性和扩展性的追求。

 - 软状态的特点

		中间状态存在：
		在分布式系统中，由于网络延迟、节点故障等原因，不同节点之间的数据同步可能无法实时完成，导致数据或状态在一段时间内处于不一致的中间状态。
		
		不影响系统可用性：
		尽管数据或状态存在中间状态，但分布式系统仍然能够保持其整体可用性，即能够继续处理用户请求和提供服务。
		
		最终一致性：
		软状态的存在是分布式系统追求最终一致性的基础。经过一段时间后，通过数据同步和一致性协议，系统能够确保所有节点上的数据或状态最终达到一致。

- 软状态与BASE理论


		BASE理论是对传统事务ACID特性（原子性、一致性、隔离性、持久性）的反思和妥协，
		它包括三个要素：基本可用（Basically Available）、软状态（Soft State）和最终一致性（Eventually Consistent）。
		在BASE理论中，软状态是其中的一个重要组成部分，它允许分布式系统在不牺牲整体可用性的前提下，通过一定的时间延迟来达到数据的一致性。


- 软状态的应用场景

		软状态在分布式系统中有着广泛的应用场景，特别是在对实时性要求不是非常高，但对可用性和扩展性要求较高的场景中。
		例如，在分布式缓存、分布式数据库、分布式文件系统等系统中，软状态的概念被广泛应用以实现数据的高可用性和可扩展性。

- 示例

	以分布式数据库为例，当一个客户端向一个节点写入了一个新值时，由于网络延迟或节点故障等原因，其他节点可能无法立即获取到这个新值。
	
	此时，这些节点上的数据就处于软状态。然而，通过数据同步和一致性协议（如Paxos、Raft等），这些节点上的数据最终会与新值保持一致，从而实现系统的最终一致性。



### 最终一致性

